<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Online-Soccer 2.0 - Greasemonkey Benutzerscripts</title>
        <link rel="stylesheet" type="text/css" href="../css/os_styles.css" />
        <link rel="stylesheet" type="text/css" href="../css/print.css" media="print" />
        <link rel="shortcut icon" type="image/ico" href="../img/favicon.ico" />
        <style>
            .script {
                border:2px solid grey;
                border-collapse:collapse;
            }
            .script td {
                border:2px solid grey;
                border-collapse:collapse;
            }
        </style>
        <script type="text/javascript">
//<![CDATA[

const GM_info = {  // Mock GM_info data
        'script' : {
                'name'        : "makeindex.html",
                'version'     : "0.10",
                'namespace'   : "http://os.ongapo.com/",
                'description' : "Online-Soccer 2.0 - Benutzerscripts unter dem Greasemonkey AddOn"
            }
    };

//]]>
        </script>

        <!-- ====================== Script-Includes: GM4-Polyfill, Module und Unit-Tests ====================== -->


        <script type="text/javascript" defer src="https://greasemonkey.github.io/gm4-polyfill/gm4-polyfill.js"></script>

        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/lib.all.js"></script>

<!--
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.log.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.value.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.class.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.class.delim.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.class.path.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/util.class.uri.js"></script>
        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/OS2.page.js"></script>
-->

        <script type="text/javascript" defer src="https://eselce.github.io/GitTest/misc/OS2/lib/test.mock.gm.js"></script>
    </head>
    <body>
        <div>
            <h3>OS2-Benutzerscripts unter dem Greasemonkey AddOn</h3>

            || <a onClick="__MAIN();return false;" href="index.html">index.html generieren</a>
            || <a onClick="__BUILDLIB('all');return false;" href="index.html">index.all.html</a>
            || <a onClick="__BUILDLIB('main');return false;" href="index.html">index.main.html</a>
            || <a onClick="__BUILDLIB('beta');return false;" href="index.html">index.beta.html</a>
            || <a onClick="__BUILDLIB('test');return false;" href="index.html">index.test.html</a>
            || <a onClick="__BUILDLIB('testmain');return false;" href="index.html">index.testmain.html</a>
            || <a onClick="__BUILDLIB('testbeta');return false;" href="index.html">index.testbeta.html</a>
            ||
        </div>
        <br />

        <script type="text/javascript">
//<![CDATA[

// ==================== Fixe Seitenbestandteile der Zieldatei ====================

function getHeader() {
    return String.raw`&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta charset="utf-8"&gt;
		&lt;title&gt;Online-Soccer 2.0 - Greasemonkey Benutzerscripts&lt;/title&gt;
		&lt;link rel="stylesheet" type="text/css" href="css/os_styles.css" /&gt;
		&lt;link rel="stylesheet" type="text/css" href="css/print.css" media="print" /&gt;
		&lt;link rel="shortcut icon" type="image/ico" href="img/favicon.ico" /&gt;
		&lt;style&gt;
			.script {
				border:2px solid grey;
				border-collapse:collapse;
			}
			.script td {
				border:2px solid grey;
				border-collapse:collapse;
			}
		&lt;/style&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;div&gt;
			&lt;script type="text/javascript"&gt;
				var popen = new Array();
				function openclose(id) {
					var inopen = false;
					var newopen = new Array();
					for (var i = 0; i &lt; popen.length; ++i) {
						if (popen[i] === id) {
							inopen = true;
						} else {
							newopen.push(popen[i]);
						}
					}
					popen = newopen;
					if (inopen === true) {
						document.getElementById('script_' + id).style.display = 'none';
						document.getElementById('openclose_' + id).src = 'img/geschlossen.gif';
					} else {
						document.getElementById('script_' + id).style.display = "";
						document.getElementById('openclose_' + id).src = 'img/offen.gif';
						popen.push(id);
					}
				}
				function opencloseFun(id){
					return (() =&gt; openclose(id));
				}
				function getMeta(meta) {
					var data = {
								'include'  : [],
								'exclude'  : [],
								'match'    : [],
								'require'  : [],
								'resource' : [],
								'grant'    : []
							};
					var match = (meta || "").match(/^\/\/ ==UserScript==\n+([^]*)\n+\/\/ ==\/UserScript==$/m);
					data.meta = (match || [])[1];
					var lines = (data.meta || "").split('\n');
					for (var i = 0; i &lt; lines.length; ++i) {
						match = lines[i].match(/^\/\/ @(\w+)\s+(.*)\s*$/);
						if (match) {
							var item = match[1];
							var value = match[2];
							if ((typeof data[item]) == 'object') {
								data[item].push(value);
							} else {
								data[item] = value;
							}
						}
					}console.error(data);
					return data;
				}
				function addRow(table, colText) {
					var tr = document.createElement('tr');
					var td;
					for (var i = 0; i &lt; colText.length; ++i) {
						td = document.createElement('td');
						td.innerHTML = colText[i];
						tr.appendChild(td);
					}
					table.appendChild(tr);
					return tr;
				}
				function purify(text) {
					return (text || "").replace(/\s+\/\s+/g, "&lt;br /&gt;");
				}
				function addEntry(table, id, meta) {
					var colText1 = [];
					var data = getMeta(meta);
					if (! data.name) { return; }
					var name = purify(data.name);
					var version = purify(data.version);
					var desc = purify(data.description);
					var author = purify(data.author);
					var filename = (id ? 'OS2.' + id + '.user.js' : undefined);
					var openclose = '"openclose(' + "'" + id + "'" + ')"';
					var install = '&lt;form method="get" action="./' + filename + '" target="_blank" rel="noopener noreferrer"&gt;' +
								//	'&lt;input type="hidden" name="scriptid" value="' + id + '" /&gt;' +
									'&lt;input type="submit" value="Installieren" /&gt;&lt;/form&gt;&lt;/td&gt;';
					colText1.push('&lt;img src="img/geschlossen.gif" style="cursor: help;" onclick=' + openclose + ' id="openclose_' + id + '" /&gt;\n' +
									'&lt;a href="https://github.com/Eselce/OS2.scripts/blob/master/' + filename + '"&gt;' + name + '&lt;/a&gt;');
					colText1.push(version);
					colText1.push(desc);
					colText1.push(author);
					colText1.push(install);
					var tr = addRow(table, colText1);
					[ '20%', '10%', null, '15%', '1%' ].forEach((minWidth, col) =&gt; {
							var cell = tr.children[col];

							cell.style.minWidth = minWidth;
							if (col &gt; 0) {
								cell.addEventListener('click', opencloseFun(id));
							}
						});
					var colText2 = [];
					colText2.push('&lt;pre&gt;' + data.meta + '&lt;/pre&gt;' + install);
					tr = addRow(table, colText2);
					tr.id = 'script_' + id;
					tr.style.display = 'none';
					tr.firstChild.setAttribute('colspan', 5);
				}
				function fillScriptTable(id, scriptMetaInfos, filter = Object.keys(scriptMeta), sortFun = undefined) {
					var table = document.getElementById(id);
					if (table && ! table.children.length) {
						var scriptIds = ((typeof filter == 'function') ? Object.keys(scriptMeta).filter(filter) : filter).sort(sortFun);
						addRow(table, [
										"Name des Scripts",
										"Aktuelle Version",
										"Beschreibung der Funktion",
										"Autor(en)",
										"Aktion"
									]).style.fontWeight = 'bold';
						for (var i = 0; i &lt; scriptIds.length; ++i) {
							script = scriptIds[i];
							addEntry(table, script, scriptMetaInfos[script]);
						}
					}
				}
`;
}

function getFooter() {
    return String.raw`
				document.addEventListener("DOMContentLoaded", createScriptTables);
				function createScriptTables(event) {
					fillScriptTable('scripts', scriptMeta, scripts);
					fillScriptTable('scriptsBeta', scriptMeta, name =&gt; ! scripts.includes(name));
				}
			&lt;/script&gt;

			&lt;h3&gt;Standard-Benutzerscripts f&amp;uuml;r Online-Soccer 2.0 unter dem Greasemonkey AddOn&lt;/h3&gt;
			&lt;table id="scripts" class="script"&gt;&lt;/table&gt;

			&lt;h3&gt;Experimentelle Scripts (Benutzung auf eigenes Risiko)&lt;/h3&gt;
			&lt;table id="scriptsBeta" class="script"&gt;&lt;/table&gt;
		&lt;/div&gt;
	&lt;/body&gt;
&lt;/html&gt;
`;
}

// ==================== Ende fixe Seitenbestandteile der Zieldatei ====================

// ==================== Abschnitt fuer Klasse Requirements ====================

// Klasse fuer das Laden einer Bibliothek aus verschiedenen Requirements
function Requirements(path, pre, ext, scripts) {
    'use strict';

    this.open = function(scripts) {
                    const __PROMISES = [];
                    const __SCRIPTS = (scripts || []);

                    for (let i = 0; i < __SCRIPTS.length; i++) {
                        const __URL = (this.srcPath + this.srcPre + __SCRIPTS[i] + this.srcExt);
                        const __REQUEST = __XHR.browse(__URL).catch(ex => Promise.resolve("// ==UserScript==\n// ==/UserScript=="));

                        __PROMISES.push(__REQUEST);
                    }

                    this.scripts = __SCRIPTS;
                    this.docs = Promise.all(__PROMISES);

                    return this.docs.then(docs => this);
                };

    this.appendPre = async function(anchor, doc) {
                         const __DOCUMENT = (doc || document);
                         const __ANCHOR = (anchor || document.body);
                         const __INDENT = "\t\t\t\t\t";

                         return await this.docs.then(docs => {
                                 for (let i = 0; i < docs.length; i++) {
                                     const __DOC = docs[i];
                                     const __MATCH = __DOC.match(/^\/\/ ==UserScript==[^]*\n\/\/ ==\/UserScript==/);
                                     const __HEADER = __MATCH[0];

                                     //console.log("Received:", __DOC);

                                     const __PRE = __DOCUMENT.createElement('pre');

                                     __PRE.textContent = __INDENT + "'" + this.scripts[i] + "' : String.raw`\n" + __HEADER.replaceAll('\r\n', '\n') + '\n' + __INDENT + "`,";

                                     __ANCHOR.appendChild(__PRE);
                                 }

                                 return this;
                             }, error => {
                                 console.error("Error:", error);
                             });
                     };

    this.srcPath = (path || "https://eselce.github.io/OS2.scripts/");
    this.srcPre = (pre || 'OS2.');
    this.srcExt = (ext || '.user.js');

    this.open(scripts);
}

//==================== Hauptprogramm ====================

const __BUILDLIB = (async (libNumber) => {
    const __LIBPATH  = "https://eselce.github.io/OS2.scripts/";   // Alternativer Scriptpfad
    const __LIBPRE = 'index';
    const __LIBEXT = '.html';
    const __SRCPRE = 'OS2.';
    const __SRCEXT = '.user.js';

    const __REQS     = new Requirements(__LIBPATH, __SRCPRE, __SRCEXT);

    const __LIBS = [
            'ergebnisse',
            'faces',
            'fssturnier',
            'haupt',
            'jugend',
            'master-SLC',
            'master',
            'osec',
            'report',
            'scripts',
            'spielbericht',
            'spielbericht.XXL',
            'spielerhistorie',
            'spielerprofil',
            'spielerstatistik',
            'spielersuche',
            'spielplan',
            'tabelle',
            'training',
            'unittest',
            'vereinshistorie',
            'vereinshistorieMitKruecke',
            'zugabgabe'
        ];
    const __LIBSMAIN = [
            'ergebnisse',
            'faces',
            'haupt',
            'jugend',
            'master',
            'spielbericht',
            'spielbericht.XXL',
            'spielerhistorie',
            'spielerprofil',
            'spielerstatistik',
            'spielersuche',
            'spielplan',
            'training',
            'vereinshistorie',
            'vereinshistorieMitKruecke'
        ];
    const __LIBSBETA = [
            'fssturnier',
            'master-SLC',
            'osec',
            'report',
            'scripts',
            'tabelle',
            'unittest',
            'zugabgabe'
        ];
    const __LIBSTEST = [
            'ergebnisse',
            'fssturnier',
            'haupt',
            'jugend',
            'scripts',
            'spielbericht.XXL',
            'spielplan',
            'tabelle',
            'training',
            'unittest',
            'zugabgabe'
        ];
    const __LIBSTESTMAIN = [
            'ergebnisse',
            'haupt',
            'jugend',
            'spielbericht.XXL',
            'spielplan',
            'training',
        ];
    const __LIBSTESTBETA = [
            'fssturnier',
            'scripts',
            'tabelle',
            'unittest',
            'zugabgabe'
        ];

    const __LIBSDEF = {
            'ALL'       : { 'reqs' : __REQS,        'libs' : __LIBS         },
            'MAIN'      : { 'reqs' : __REQS,        'libs' : __LIBSMAIN     },
            'BETA'      : { 'reqs' : __REQS,        'libs' : __LIBSBETA     },
            'TEST'      : { 'reqs' : __REQS,        'libs' : __LIBSTEST     },
            'TESTMAIN'  : { 'reqs' : __REQS,        'libs' : __LIBSTESTMAIN },
            'TESTBETA'  : { 'reqs' : __REQS,        'libs' : __LIBSTESTBETA }
        };

    const __LIBPKGS = {
            ''          : 'ALL',
            'all'       : 'ALL',
            'main'      : 'MAIN',
            'beta'      : 'BETA',
            'test'      : 'TEST',
            'testmain'  : 'TESTMAIN',
            'testbeta'  : 'TESTBETA'
        };
    const __LIBPKGKEYS = Object.keys(__LIBPKGS);

    // libNumber: Lfd. Nummer der Keys oder uebergebener Name...
    const __PKGNAME = (Number.isInteger(libNumber) ? __LIBPKGKEYS[Math.max(0, Number.parseInt(libNumber, 10))] : (libNumber || ''));
    const __LIBNAME = __LIBPRE + __PKGNAME + __LIBEXT;
    const __PKGDEF = __LIBPKGS[__PKGNAME];
    const __PKGLIBS = (((typeof __PKGDEF) === 'string') ? [ __PKGDEF ] : __PKGDEF);
    const __ALLLIBS = __PKGLIBS.reduce((sum, libsKey) => sum.concat(__LIBSDEF[libsKey].libs), []).map(
                                        script => ((__LIBSBETA.includes(script) ? "//" : "") + "\t'" + script + "'"));
    const __PKGFUNS = __PKGLIBS.map(libsKey => (() => __LIBSDEF[libsKey].reqs.open(__LIBSDEF[libsKey].libs).then(reqs => reqs.appendPre(document.body))));
    const __INDENT = "\t\t\t\t\t";

    // Header...
    document.body.innerHTML = "<pre>" + getHeader() + "\n/****** Benutzerscript-Uebersicht " + __LOG.info(__LIBNAME, false) + ' ' + __LOG.info(__PKGLIBS, false) + " ******/\n\n"
                            + __PKGLIBS.reduce((pre, libsKey) => pre + __LIBSDEF[libsKey].libs.map(libName => (__LIBSDEF[libsKey].reqs.srcPre + libName + __LIBSDEF[libsKey].reqs.srcExt)
                                    ).reduce((pre, lib) => pre + "\n//\t" + lib, "\n// " + __LIBSDEF[libsKey].reqs.srcPath + '&lt;' + libsKey + "&gt;: "),
                                "// Inhaltsverzeichnis:") + "\n\n" + __INDENT.substr(1) + "var scriptMeta = {</pre>";

    // Promise-Chain abarbeiten...
    const __LIBREQS = await __PKGFUNS.reduce((prom, fun) => prom.then(fun, defaultCatch), Promise.resolve()).then(reqs => {
            // Footer...
            document.body.innerHTML = document.body.innerHTML + "<pre>" + __INDENT + "};\n\n" + __INDENT.substr(1) + "var scripts = [\n" + __INDENT
                                                                + __ALLLIBS.join(",\n" + __INDENT)
                                                                + '\n' + __INDENT + "];\n" + getFooter() + "</pre>";
            return reqs;
        });

    return __LIBREQS;
});

const __MAIN = (async () => {
    // URL-Legende (lib=n oder lib=pkgname):
    // lib=0: index.html        (default)
    // lib=1: index.all.html    (lib=all)
    // lib=2: index.main.html   (lib=main)
    // lib=3: index.beta.html   (lib=beta)

    // Verzweige in unterschiedliche Verarbeitungen je nach Wert von lib:
    const __LIBNUMBER = getPageIdFromURL(window.location.href, {
                'index.html' : 1   // Ansicht "Bibliothek generieren" (lib = 0, 1, 2, 3 bzw. lib = all, main, beta, ...)
            }, 'lib');
    const __REQS = __BUILDLIB(__LIBNUMBER);

    return __REQS;
});

//]]>
        </script>
        <noscript>Your browser does not support JavaScript!</noscript>
    </body>
</html>
